sequenceDiagram
    participant User
    participant Agent
    participant Cache
    participant LLM as LLM API
    participant DB as Database

    User->>Agent: User Input: "Jak zbudować mapę?"
    
    activate Agent
    Agent->>Agent: Validate input
    Agent->>DB: Load conversation history
    activate DB
    DB-->>Agent: History: []
    deactivate DB
    
    Agent->>Agent: Load system prompt template
    Agent->>Agent: Build analysis prompt
    Agent->>Agent: Tokenize & validate length
    
    Agent->>Cache: Check cache for similar prompt
    activate Cache
    Cache-->>Agent: Cache miss
    deactivate Cache
    
    Agent->>LLM: Invoke<br/>⚙️ SYSTEM PROMPT=System Prompt<br/>❓ ROLE=User, TEXT=Prompt<br/>
    
    activate LLM
    LLM->>LLM: Process analysis
    LLM-->>Agent: Return analysis result<br/> needs clarification: true/false,<br/> additional question: "Jaki framework?"
    deactivate LLM
    
    alt needs_clarification == true
        Agent->>Agent: Build clarification prompt

        Agent->>User: Ask clarification:<br/>"Jaki framework, wariacie..?"
        Activate User
        User-->>Agent: "Sveltekit"
        Deactivate User

        Agent->>Agent: Validate clarification response
        
        Agent->>LLM: Invoke<br/>⚙️ SYSTEM PROMPT=System Prompt<br/>❓ ROLE=User, TEXT=Previous Prompt<br/>✨ ROLE=Assistant, TEXT=Previous Answer<br/>❓ ROLE=User, TEXT=prompt
        
        activate LLM
        LLM->>LLM: Generate response
        LLM-->>Agent: Return:<br/>Response
        deactivate LLM
        
        Agent->>Agent: Parse response
        Agent->>Agent: Format response
    else needs_clarification == false
        Agent->>Agent: Parse analysis result
        Agent->>Agent: Build final response
    end
        
        Agent->>DB: Save to conversation history
        activate DB
        DB-->>Agent: Acknowledgment
        deactivate DB

        Agent->>User: Send response